/*---------------------------------------------------------
 * Copyright (C) Microsoft Corporation. All rights reserved.
 *--------------------------------------------------------*/
define("vs/css!vs/workbench/contrib/build/media/buildviewlet",["vs/css!vs/workbench/contrib/build/buildViewlet"],{});var __extends=this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);n.prototype=t.prototype,e.prototype=new n};define("vs/workbench/contrib/build/buildViewlet",["require","exports","vs/base/lib/winjs.base","vs/nls!vs/workbench/contrib/build/buildViewlet","vs/platform/services","vs/base/strings","vs/base/assert","vs/base/objects","vs/base/errors","vs/workbench/ui/parts/viewlet","vs/base/ui/widgets/tree/treeImpl","vs/base/dom/dom","vs/base/dom/builder","vs/base/ui/widgets/leftRightWidget/leftRightWidget","vs/base/ui/widgets/countBadge/countBadge","vs/base/ui/widgets/tree/treeDefaults","vs/base/ui/events","vs/workbench/contrib/build/build","vs/workbench/contrib/build/buildWorkspaceService","vs/workbench/contrib/build/buildModel","vs/base/ui/actions","vs/editor/modes/modesExtensions","vs/workbench/contrib/build/buildConstants","vs/css!./media/buildviewlet"],function(e,t,n,r,i,o,s,a,l,c,u,d,p,h,m,f,g,v,b,y,_,w,S){var E=p.$,T=function(){function e(){}return e.prototype.getId=function(e,t){return t instanceof y.FileWithErrors?t.path():t instanceof y.BuildError?t.getId():t instanceof y.BuildResult?t.getId():(s.ok(!1,t?"Element has unsupported type "+(t.constructor?t.constructor.name:"unknown"):"Element is null"),"")},e.prototype.getChildren=function(e,t){var r=[];return t instanceof y.FileWithErrors?r=t.errors():t instanceof y.BuildResult&&(r=t.filesWithErrors()),n.Promise.as(r)},e.prototype.hasChildren=function(e,t){return t instanceof y.FileWithErrors||t instanceof y.BuildResult},e.prototype.getParent=function(e,t){var r=null;return t instanceof y.BuildError?r=t.parent():t instanceof y.FileWithErrors&&(r=t.parent()),n.Promise.as(r)},e}();t.BuildDataSource=T;var k=function(){function e(e){this.contextService=e}return e.prototype.getHeight=function(){return 24},e.prototype.render=function(e,t,n){var i=E(n);return i.isEmpty()||i.empty(),t instanceof y.FileWithErrors?i.div({class:"file-with-errors"},function(e){new h.LeftRightWidget(e,function(e){return E("a.name.plain").text(t.name()).appendTo(e),t.directory().length>0&&E("span.directory").text(t.directory()).appendTo(e),null},function(e){var n=t.errors().length;return new m.CountBadge(e,n,n>1?r.localize("vs_workbench_contrib_build_buildViewlet",0,n):r.localize("vs_workbench_contrib_build_buildViewlet",1,n))})}):t instanceof y.BuildError&&i.div({class:"builderror"},function(e){var n=o.format("{0} ({1})",t.errorMessage(),t.lineNumber());e.a({class:"plain",title:n,text:n})}),null},e}();t.BuildRenderer=k;var C="workbench.view.build",x=function(e){function t(t){var n=this;e.call(this,t,C),this.progressService=t.progressService,this.editorService=t.editorService,this.messageService=t.messageService,this.contextService=t.contextService,this.instantiationService=t.instantiationService,this.buildWorkspaceService=t.buildWorkspaceService,this.progressRunner=null,this.toUnbind.push(this.buildWorkspaceService.addListener("error",function(e){return n.showError(e)})),this.toUnbind.push(this.buildWorkspaceService.addListener("changed",function(){return n.refresh()})),this.toUnbind.push(this.buildWorkspaceService.addListener("changedState",function(e){return n.buildChangedState(e)})),this.toUnbind.push(this.buildWorkspaceService.addListener("changedBuildResult",function(){return n.onBuildResultChange()}))}return __extends(t,e),t.prototype.create=function(t){var r=this;return e.prototype.create.call(this,t),t.div({class:"build-viewlet"},function(e){e.addClass("build-viewlet"),r.messages=e.div({class:"messages"}).hide().clone();var t=new T;e.div({class:"results"},function(e){r.buildResultsContainer=e,r.tree=new u.Tree(e.getHTMLElement(),{dataSource:t,renderer:new k(r.contextService),controller:new f.DefaultController({clickBehavior:f.ClickBehavior.ON_MOUSE_DOWN})},{indentPixels:14}),r.toUnbind.push(r.tree.addListener(g.EventType.SELECTION,function(e){return r.onSelection(e)}))}),r.refresh()}),n.Promise.as(null)},t.prototype.setVisible=function(t){var r=this;return e.prototype.setVisible.call(this,t).then(function(){var e;return e=t&&r.needsRefresh?r.refresh():n.Promise.as(null),e.then(function(){if(t&&a.mixin(r.telemetryData,{status:r.buildWorkspaceService.getBuildState(),errorCount:r.buildWorkspaceService.buildResult?r.buildWorkspaceService.getErrorCount():0}),r.tree.layout(),t&&!r.editorService.getActiveEditorInput()){var e=r.tree.getFocus();e&&r.openSelection([e])}})})},t.prototype.focus=function(){e.prototype.focus.call(this),this.tree.DOMFocus()},t.prototype.layout=function(t){e.prototype.layout.call(this,t);var n=t.height;this.buildResultsContainer.style({height:n+"px"}),this.tree.layout()},t.prototype.getControl=function(){return this.tree},t.prototype.dispose=function(){this.tree&&this.tree.dispose(),e.prototype.dispose.call(this)},t.prototype.showError=function(e){this.messageService.show(2,e),this.refresh()},t.prototype.buildChangedState=function(e){e===b.Status.IN_PROGRESS?(this.progressRunner&&this.progressRunner.done(),this.progressService&&(this.progressRunner=this.progressService.show(!0))):this.progressRunner&&(this.progressRunner.done(),this.progressRunner=null)},t.prototype.onBuildResultChange=function(){this.tree.setInput(this.buildWorkspaceService.buildResult).done(null,l.onUnexpectedError)},t.prototype.refresh=function(){var e=this;if(!this.isVisible())return this.needsRefresh=!0,n.TPromise.as(null);if(this.needsRefresh=!1,this.buildWorkspaceService.getBuildError())return this.buildWorkspaceService.getBuildState()===b.Status.NO_BUILD_CONFIG&&this.showMessage(this.buildWorkspaceService.getBuildError()),n.TPromise.as(null);if(this.buildWorkspaceService.getBuildState()===b.Status.NOT_RUN)return this.showMessage(r.localize("vs_workbench_contrib_build_buildViewlet",2)),n.TPromise.as(null);if(this.buildWorkspaceService.isBuildSuccess())return this.showMessage(r.localize("vs_workbench_contrib_build_buildViewlet",3)),this.tree.setInput(this.buildWorkspaceService.buildResult).then(function(){e.tree.layout()});if(this.buildWorkspaceService.buildResult){if(0===this.buildWorkspaceService.buildResult.filesWithErrors().length)return this.showMessage(r.localize("vs_workbench_contrib_build_buildViewlet",4)),this.showSeeLogMessage(),this.tree.setInput(this.buildWorkspaceService.buildResult).then(function(){e.tree.layout()});this.messages.hide(),this.buildResultsContainer.show();var t,i=this.tree.getInput();return t=i?this.tree.refresh():this.tree.setInput(this.buildWorkspaceService.buildResult),t.then(function(){e.tree.layout(),e.expandFiles()})}return n.TPromise.as(null)},t.prototype.expandFiles=function(){var e=this,t=this.buildWorkspaceService.buildResult.filesWithErrors();this.buildWorkspaceService.getErrorCount()<30&&t.forEach(function(t){return e.tree.expand(t).done(null,l.onUnexpectedError)})},t.prototype.onSelection=function(e){this.openSelection(e.selection,e)},t.prototype.openSelection=function(e,t){if(e[0]instanceof y.BuildError){var n=e[0],r=n.parent().path(),i=t&&t.payload&&t.payload.originalEvent&&(t.payload.originalEvent.ctrlKey||t.payload.originalEvent.metaKey);this.editorService.openEditor({resource:this.contextService.toResource(r),options:{selection:{startLineNumber:n.lineNumber(),startColumn:n.column()},preserveFocus:t&&"mouse"===t.payload.origin}},i).done(null,l.onUnexpectedError)}},t.prototype.showMessage=function(e){this.isVisible()&&(this.buildResultsContainer.hide(),E(this.messages).empty().show().div({class:"message",text:e}))},t.prototype.showSeeLogMessage=function(){var e=this;this.isVisible()&&(this.buildResultsContainer.hide(),E(this.messages).empty().show().div({class:"message"},function(t){t.span({class:"detail",text:r.localize("vs_workbench_contrib_build_buildViewlet",5)}).a({class:["pointer","prominent"],text:r.localize("vs_workbench_contrib_build_buildViewlet",6)}).on(d.EventType.CLICK,function(t){d.EventHelper.stop(t,!1),e.openLog(t.ctrlKey||t.metaKey).done(null,l.onUnexpectedError)})}))},t.prototype.openLog=function(e){var t=this.buildWorkspaceService.getBuildType(),n={taskPattern:null,errorPattern:null};return t&&t.taskPattern&&(n.taskPattern=t.taskPattern),t&&t.errorPattern&&(n.errorPattern=t.errorPattern.pattern),w.configureMode(S.BUILD_LOG_MODE_ID,n),this.editorService.openEditor(v.BuildLogEditorInput.getInstance(this.instantiationService),null,e)},t.prototype.getSelection=function(){return new i.StructuredSelection(this.tree.getSelection())},t.prototype.getActions=function(){var e=this;return[new _.Action("buildViewlet.actions.build",r.localize("vs_workbench_contrib_build_buildViewlet",7),"build-action runbuild",!0,function(){return e.buildWorkspaceService.requestBuild()}),new _.Action("buildViewlet.actions.openLog",r.localize("vs_workbench_contrib_build_buildViewlet",8),"build-action openlog",!0,function(t){return e.openLog(t&&(t.ctrlKey||t.metaKey))})]},t}(c.Viewlet);t.BuildViewlet=x});