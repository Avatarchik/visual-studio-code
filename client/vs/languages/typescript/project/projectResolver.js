/*---------------------------------------------------------
 * Copyright (C) Microsoft Corporation. All rights reserved.
 *--------------------------------------------------------*/
"use strict";define("vs/base/db/indexeddb",["require","exports","vs/base/types","vs/base/lib/winjs.base","vs/base/errors"],function(e,t,r,n,s){function a(){return"undefined"!=typeof indexedDB}function o(e,t,r){return new n.TPromise(function(n,s){var a;a="undefined"!=typeof t?indexedDB.open(e,t):indexedDB.open(e),a.onerror=function(e){return s(e)},a.onsuccess=function(e){return n(new u(e.target.result))},a.onupgradeneeded=function(e){if(!r)return s(e);var t=e.target.result;r({createDataStore:function(e){var r=t.createObjectStore(e.name,{keyPath:e.keyPath,autoIncrement:e.autoIncrement});e.index&&e.index.forEach(function(e){return r.createIndex(e.name,e.keyPath,e.options)})},deleteDataStore:function(e){t.deleteObjectStore(e)}},t)}})}function i(e){return new n.TPromise(function(t,r){e.onsuccess=function(){t(e)},e.onerror=function(t){r(e.error||t)}})}t.canBeUsed=a,function(e){e[e.ReadOnly=0]="ReadOnly",e[e.ReadWrite=1]="ReadWrite",e[e.VersionChange=2]="VersionChange"}(t.TransactionMode||(t.TransactionMode={}));var l,l=t.TransactionMode;!function(e){function t(t){return e[t]?e[t].toLowerCase():null}e.toString=t}(l=t.TransactionMode||(t.TransactionMode={})),function(e){e[e.Next=0]="Next",e[e.NextUnique=1]="NextUnique",e[e.Prev=2]="Prev",e[e.PrevUnique=3]="PrevUnique"}(t.Direction||(t.Direction={}));var c,c=t.Direction;!function(e){function t(t){return e[t]?e[t].toLowerCase():null}e.toString=t}(c=t.Direction||(t.Direction={})),t.openDatabase=o;var u=function(){function e(e){this._db=e}return Object.defineProperty(e.prototype,"db",{get:function(){return this._db},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){this._db.close()},e.prototype.createTransaction=function(e,t){return"undefined"!=typeof t?this._db.transaction(e,l.toString(t)):this._db.transaction(e)},e.prototype.objectStore=function(e){return this._db.objectStoreNames.contains(e)?new d(e,this):null},e}();t.Database=u;var d=function(){function e(e,t){this._name=e,this._database=t}return Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"store",{get:function(){return this._database.db.transaction(this._name).objectStore(this._name)},enumerable:!0,configurable:!0}),e.prototype.executeTransaction=function(e,t){var r=this;return new n.TPromise(function(n,a){var o,i;try{o=r._database.db.transaction(r._name,l.toString(e))}catch(c){return"InvalidStateError"===c.name&&(c=s.canceled()),a(c)}o.onerror=function(e){return a(e.target.error)},o.oncomplete=function(){return n(i)},o.onabort=function(){return a(s.canceled())};try{i=t(o.objectStore(r._name),o)}catch(c){o.abort(),a(c)}})},e.prototype.openCursor=function(e,t,r,n){return m.openCursor(this,null,e,t,r,n)},e.prototype.openIndexCursor=function(e,t,r,n,s){var a=this;return this.executeTransaction(t,function(){return m.openCursor(a,e,t,r,n,s)}).then(function(e){return e})},e.prototype.get=function(e){return this.executeTransaction(l.ReadOnly,function(t){return i(t.get(e))}).then(function(e){return e}).then(function(e){return e.result})},e}();t.ObjectStore=d;var m;!function(e){function t(e,t,s,a,o,i){var l,u=c.Next;return r.isFunction(a)?i=a:r.isFunction(o)?(l=a,i=o):(l=a,u=o),new n.TPromise(function(r,n){var a,o=[];e.executeTransaction(s,function(e){var r;r=t?e.index(t).openCursor(l,c.toString(u)):e.openCursor(l,c.toString(u)),r.onsuccess=function(t){var r=t.target;r.result&&o.push(i(r.result.value,r.result,e))},r.onerror=function(e){return a=e}}).then(function(){a?n(a):r(o)},n)})}e.openCursor=t}(m||(m={}))}),define("vs/languages/typescript/typescript",["require","exports","vs/platform/platform"],function(e,t,r){var n;!function(e){e.ResourceSetChanged="typescript.resourceSetChanged"}(n=t.Events||(t.Events={}));var s;!function(e){function t(e){s=e}function n(){return s}e.Identifier="typescript",r.Registry.add(e.Identifier,e);var s;e.setProjectResolver=t,e.getProjectResolver=n}(s=t.Extensions||(t.Extensions={}))}),define("vs/base/trie",["require","exports","vs/base/collections","vs/base/assert"],function(e,t,r,n){function s(e,t){void 0===t&&(t=h);var n,s;return n={_key:null,_parent:null,_children:{},parent:function(){return null},children:function(e){return void 0===e&&(e=!1),l(this,e)}},s={insert:function(e,r){return a(n,t(e),r)},lookUp:function(e,r){return void 0===r&&(r=!1),o(n,t(e),r)},roots:function(){return l(n,!1)},values:function(){return c(n)},fringe:function(){return u(n)},remove:function(e){return d(e)},forEach:function(e){return m(n,e)}},"undefined"!=typeof e&&r.forEach(e,function(e){s.insert(e.key,e.value)}),s}function a(e,t,r){for(var n=0,s=t.length,a=e;s>n&&(a=e._children[t[n]]);)e=a,n+=1;for(;s>n;)a={_key:t[n],_parent:e,_children:{},parent:function(){return i(this)},children:function(e){return void 0===e&&(e=!1),l(this,e)}},e._children[t[n]]=a,e=a,n+=1;return a.element=r,a}function o(e,t,r){for(var n=0,s=t.length,a=e,o=void 0!==a.element?a:void 0;s>n&&(a=e._children[t[n]]);)e=a,n+=1,void 0!==a.element&&(o=a);return a&&void 0!==a.element?a:r&&void 0!==o?o:null}function i(e){for(;e._parent;){if("undefined"!=typeof e._parent.element)return e._parent;e=e._parent}return null}function l(e,t){for(var n=[],s=r.values(e._children);s.length>0;)e=s.shift(),void 0!==e.element&&n.push(e),(t||void 0===e.element)&&s.push.apply(s,r.values(e._children));return n}function c(e){for(var t=[],n=[e];n.length>0;)e=n.pop(),void 0!==e.element&&t.push(e.element),r.forEach(e._children,function(e){n.push(e.value)});return t}function u(e){for(var t=[e],s=[];t.length>0;){var a=t.pop(),o=t.length;r.forEach(a._children,function(e){t.push(e.value)}),o===t.length&&null!==a._key&&(n.ok("undefined"!=typeof a.element),s.push(a))}return s}function d(e){return e._parent?e._parent._children[e._key]!==e?!1:(delete e._parent._children[e._key],"undefined"==typeof e._parent.element&&p(e._parent._children)&&d(e._parent),!0):!1}function m(e,t){r.forEach(e._children,function(e){void 0!==e.value.element&&t(e.value),m(e.value,t)})}function p(e){if(!e)return!0;for(var t in e)if(f.call(e,t))return!1;return!0}var h=function(e){return e.split("")};t.newTrie=s;var f=Object.prototype.hasOwnProperty});var __extends=this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);r.prototype=t.prototype,e.prototype=new r};define("vs/languages/typescript/project/projectResolver",["require","exports","vs/base/env","vs/base/hash","vs/base/strings","vs/base/paths","vs/base/errors","vs/base/lifecycle","vs/base/collections","vs/base/db/indexeddb","vs/base/lib/winjs.base","vs/platform/services","vs/languages/typescript/typescript","vs/base/trie"],function(e,t,r,n,s,a,o,i,l,c,u,d,m,p){var h;!function(e){function t(e){return"monaco_"+n.computeMurmur2StringHashCode(e)}function r(t,r){return c.openDatabase(t,1,function(t,r){for(var n=0,s=r.objectStoreNames.length;s>n;n++)t.deleteDataStore(r.objectStoreNames.item(n));t.createDataStore({name:e.storeName,keyPath:e.keyPath,index:[e.workspaceIndexOptions]})}).then(function(t){return r.push(t),t.objectStore(e.storeName)},function(){return null})}e.databaseName=t,e.keyPath="workspaceAbsolutePath",e.storeName="cache",e.workspaceIndexOptions={name:"workspaceName",keyPath:"workspaceName",options:{unique:!1}},e.openStore=r}(h||(h={}));var f=function(){function e(){}return e.prototype.resolve=function(){return null},e.Instance=new e,e}();t.NullProjectResolver=f;var g;!function(e){function t(e,t,r){for(var n=p.newTrie({},function(e){return e.split(a.sep).filter(function(e){return!s.isFalsyOrWhitespace(e)})}),o=p.newTrie(),i=!1,l=0,c=e.length;c>l;l++){var u=e[l];u&&(u.type===d.Files.FileChangeType.DELETED?o.insert(u.path,u):(u.type===d.Files.FileChangeType.ADDED||u.type===d.Files.FileChangeType.UPDATED)&&n.insert(u.path,u))}o.roots().forEach(function(e){r(e.element.path),i=!0});for(var m=n.roots();m.length>0;){var h=m.shift(),u=h.element;if(u.type===d.Files.FileChangeType.ADDED)t(u.path);else if(u.type===d.Files.FileChangeType.UPDATED){var f=h.children(),c=f.length;if(0===c)continue;for(var g=0,l=0;c>l;l++)f[l].element.type===d.Files.FileChangeType.ADDED&&(g+=1);g>1?(t(u.path),i=!0):m.push.apply(m,f)}}return i}e.minimize=t}(g=t.FileEventProcessing||(t.FileEventProcessing={}));var v=function(){function e(e,t){var r=this;this._fileService=e.fileService,this._eventService=e.eventService,this._options=t,this._disposables=[];var n=e.eventService.addListener(d.Files.EventType.FILE_CHANGES,function(e){var t=e.filter(function(e,t){return!t.some(function(e){return".git"===e||"node_modules"===e})}).changes;g.minimize(t,function(e){return r._handleAdded(e)},function(e){return r._handleDelete(e)})&&r._eventService.emit(m.Events.ResourceSetChanged)});this._disposables.push({dispose:n}),this._pendingOperations=[u.TPromise.timeout(0).then(function(){return r._resolveStatsAndContents("/")})]}return e.prototype.dispose=function(){this._disposables=i.disposeAll(this._disposables)},e.prototype._handleDelete=function(e){this._pendingOperations.push(u.TPromise.as({removed:[e]}))},e.prototype._handleAdded=function(e){this._pendingOperations.push(this._resolveStatsAndContents(e))},e.prototype.resolve=function(){var e=this,t=this._pendingOperations.length;if(0===t)return u.TPromise.as({});if(this._resolverError)return u.TPromise.wrapError(this._resolverError);var r={added:[],removed:[],hasChanges:!1};return u.TPromise.join(this._pendingOperations.splice(0,t).map(function(t){return t.then(function(e){r.added.push.apply(r.added,e.added),r.removed.push.apply(r.removed,e.removed),r.hasChanges=r.hasChanges||e.hasChanges},function(t){if(!o.isPromiseCanceledError(t))throw e._resolverError=t,t})})).then(function(){return r},function(t){e._resolverError=t})},e.prototype._resolveStatsAndContents=function(e){var t=this;return this._fetchStats(e).then(function(r){return t._fetchContents(e,r)},function(e){if(404===e.status)return[];throw e}).then(function(e){return{added:e}})},e.prototype._fetchStats=function(e){return this._fileService.resolveFileStats(e,this._options.pattern)},e.prototype._fetchContents=function(e,t){return this._fileService.resolveContents(t.map(function(e){return e.path}))},e}(),b=function(){function e(){this._value=Object.create(null)}return e.prototype.change=function(){this._value=Object.create(null)},Object.defineProperty(e.prototype,"value",{get:function(){return this._value},enumerable:!0,configurable:!0}),e}(),y=function(e){function t(t,r){e.call(this,t,r),this._workspaceName=t.contextService.getWorkspace()?t.contextService.getWorkspace().name:"__NO_WORKSPACE__",this._databaseName=h.databaseName(r.modeId),this._state=new b}return __extends(t,e),t.prototype._getObjectStore=function(){return this._objectStorePromise||(this._objectStorePromise=h.openStore(this._databaseName,this._disposables)),this._objectStorePromise},t.prototype._handleDelete=function(t){var r=this;this._pendingOperations.push(this._getObjectStore().then(function(e){return e?e.openIndexCursor(h.workspaceIndexOptions.name,c.TransactionMode.ReadWrite,IDBKeyRange.only(r._workspaceName),function(e,n,s){a.isEqualOrParent(e.content.path,t)&&(s.delete(e.workspaceAbsolutePath),r._state.change()),n.continue()}):void 0})),e.prototype._handleDelete.call(this,t)},t.prototype._resolveStatsAndContents=function(t){var r=this,n=this._state.value;return e.prototype._resolveStatsAndContents.call(this,t).then(function(e){return e.hasChanges=n!==r._state.value,e})},t.prototype._fetchContents=function(t,r){var n=this;return this._getObjectStore().then(function(s){return s?n._doFetchContents(s,t,r).then(function(e){return e.persistedContents.concat(e.volatileContents)}):e.prototype._fetchContents.call(n,t,r)})},t.prototype._doFetchContents=function(t,r,n){var s=this,i=a.join(this._workspaceName,r),u={},m={volatileContents:[],persistedContents:[]};return n.forEach(function(e){var t=a.join(s._workspaceName,e.path);if(l.lookupOrInsert(u,t,e)!==e)throw new Error("path collision between two different stat objects. path: "+t)}),t.openIndexCursor(h.workspaceIndexOptions.name,c.TransactionMode.ReadWrite,IDBKeyRange.only(this._workspaceName),function(e,t,r){var n=l.lookup(u,e.workspaceAbsolutePath);a.isEqualOrParent(e.workspaceAbsolutePath,i)&&(n&&n.etag===e.content.etag&&d.Files.isIContent(e.content)?(delete u[e.workspaceAbsolutePath],m.persistedContents.push(e.content)):(r.delete(e.workspaceAbsolutePath),s._state.change())),t.continue()}).then(function(){return e.prototype._fetchContents.call(s,r,l.values(u))}).then(function(e){return t.executeTransaction(c.TransactionMode.ReadWrite,function(t){e.forEach(function(e){t.put({workspaceName:s._workspaceName,workspaceAbsolutePath:a.join(s._workspaceName,e.path),content:{resource:void 0,charset:e.charset,etag:e.etag,mime:e.mime,mtime:e.mtime,name:e.name,path:e.path,value:e.value}}),s._state.change(),m.persistedContents.push(e)})}).then(void 0,function(t){if(!o.isPromiseCanceledError(t))throw t;m.volatileContents=e})}).then(function(){return m})},t}(v),w=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t.prototype._doFetchContents=function(t,r,n){return e.prototype._doFetchContents.call(this,t,r,n).then(function(e){return e.persistedContents.length=0,e})},t}(y),_=function(){function e(e,t){this._delegate=e.fileService?c.canBeUsed()?r.browser.isFirefox?e.instantiationService.createInstance(y,t):e.instantiationService.createInstance(w,t):e.instantiationService.createInstance(v,t):f.Instance}return e.prototype.resolve=function(){return this._delegate.resolve()},e}();t.ProjectResolver=_;var T=function(){function e(e,t){this._disposables=[],this._workspaceName=e.contextService.getWorkspace()?e.contextService.getWorkspace().name:"__NO_WORKSPACE__",this._databaseName=h.databaseName(t)}return e.prototype.dispose=function(){this._disposables=i.disposeAll(this._disposables)},e.prototype.resolve=function(e){if(s.isFalsyOrWhitespace(this._workspaceName))return u.TPromise.as(null);var t=a.join(this._workspaceName,e);return this._getObjectStore().then(function(e){return e?e.get(t).then(function(e){return e?e.content:null}):null})},e.prototype.accept=function(e){var t,r=this;return new u.TPromise(function(n,s){r._getObjectStore().then(function(n){return n?n.openIndexCursor(h.workspaceIndexOptions.name,c.TransactionMode.ReadWrite,IDBKeyRange.only(r._workspaceName),function(r,n){e(r.content),t||n.continue()}):void 0}).then(function(){return n(null)},s)},function(){t=o.canceled()})},e.prototype._getObjectStore=function(){return this._objectStorePromise||(this._objectStorePromise=h.openStore(this._databaseName,this._disposables)),this._objectStorePromise},e}();t.DatabaseContentResolver=T});